function [sys,x0,str,ts] = sfun_RTAC(t,x,u,flag)
%%
switch flag
    case 0
        [sys,x0,str,ts] = mdlInitializeSizes;
    case 1
        sys = mdlDerivatives(t,x,u);
    case 3
        sys = x;
    case {2,4,9}
        sys = [];
    otherwise
        error(['Unhandled flag = ', num2str(flag)]);
end

function [sys,x0,str,ts] = mdlInitializeSizes
%%
sizes = simsizes;
sizes.NumContStates  = 4;   %连续状态个数
sizes.NumDiscStates  = 0;   %离散状态个数
sizes.NumOutputs     = 4;   %输出个数
sizes.NumInputs      = 1;   %输入个数
sizes.DirFeedthrough = 0;   %是否直接馈入
sizes.NumSampleTimes = 1;   %采样时间个数，至少一个
sys = simsizes(sizes);     %将size结构传到sys中

x0  = [0.038;0;1e-3;0];                     %初始状态向量，由传入的参数决定，没有为空
str = [];
ts  = [0 0];                  %设置采样时间

function sys = mdlDerivatives(t,x,u)
%%
% if t>0&&t<5
%     u(1) = 0.2*sin(t);
% else
%     u(1) = 0;
% end

%------对象描述------------

eps_p = 0.2;
A0 = [0,1,0,0;
    -1,0,eps_p/pi,0;
    0,0,0,1;
    0,0,0,0];
B0 = [0,0,0,1]';
A1 = [0,0,0,0;
    0,0,eps_p,0;
    0,0,0,0;
    0,0,0,0];
B1 = zeros(4,1);
A2 = -A1;
B2 = B1;

if x(3)>=-2.3137&&x(3)<=2.3137
    w1 = (sin(x(3))/x(3))-(1/pi);
    w2 = 0;
else
    w1 = 0;
    w2 = (1/pi)-(sin(x(3))/x(3));
end 
%控制器
%class1:parameter independent
% K = [1.109629172436706,-1.427569551431865,-1.762162912228983,-1.716300431844927];
%class1:guaranteed cost
% K = [-0.342223638107757,-7.208843640430081,-3.774810480481321,-2.220502388983783];
%class2:parameter dependent
% K0 = [0.986127024536375,-1.443646623429111,-1.773738295707779,-1.521217684955168];
% K1 = [0.324286052926536,-0.259932965413582,-0.241521588992504,-0.516746968904972];
% K2 = [0.208444946052999,-0.186192166906331,-0.160214489327053,-0.332254750878806];
%class2:guaranteed cost
% K0 = [-1.742765597759083,-6.388617386794328,-3.557431550020464,-0.735992203771193];
% K1 = [-0.150724641058870,-0.278109888220313,-0.606742466830423,-0.345102969410938];
% K2 = [-0.241715319365954,-2.185115057967206,-0.580033193984040,-0.245052045784109];
% K = K0+K1*w1+K2*w2;
%class3:Parameter-dependent controller design method with parameter-dependent Lyapunovfunctions
% P0 = [3.31790238801190,-0.0742381143886952,0.0390217308472625,2.36882599205576;-0.0742381143886952,3.31486398097952,-0.215609993498220,-0.0628726431127716;0.0763400400559351,-4.59446509899639,2.62567558021591,-0.847559256306564;2.36882599205576,-0.0628726431127716,-0.678525723847879,2.98686915414486];
% P1 = [0.0389539977246846,-0.0502984290928117,-0.0270779163830461,0.0139790334281244;0.0410165067391868,0.0396658435058988,-0.0175433100293101,-0.200060445286423;0.0904369837519709,-0.0105520733096547,0.448366872058504,-0.389616282706837;-0.0131481388234456,0.0895822270903480,0.202252615333278,0.674839702762899];
% P2 = [0.0372479317733199,-0.0384711150805770,0.0529479241077643,0.00971741174452920;0.0491976185340839,0.0383916296019407,-0.0375711864299434,0.140740323283211;-0.0584861854055659,0.00370366453252195,0.479933746036677,-0.230984043042775;0.00717655754826898,-0.0595362860330879,0.0967471228740561,0.618971858835966];
% P = P0+w1*P1+w2*P2;
% Pi0 = [0.081705232793184,2.412915580835142,-2.810055281218967,-1.166485572604295];
% Pi1 = [-0.081198024957225,0.066508470105577,-0.481355873099813,-0.392421843392602];
% Pi2 = [0.042258617709348,-0.038475382798102,-0.404830056001575,-0.257142171078784];
% Pi = Pi0+w1*Pi1+w2*Pi2;
%class3:guaranteed cost
P0 = [0.0181921701010848,-0.000457466947838701,0.00151529677248601,0.0242857201969767;-0.000457466947838701,0.0189221470477195,-0.00450146149893038,-0.00202224371832372;-0.0138372650663726,-0.0504169392644893,0.0916942384840179,-0.0297805474497648;0.0242857201969767,-0.00202224371832372,-0.122446406729043,0.191882764434201];
P1 = [0.000321392427723503,-0.000299290572313902,0.00107185405122241,-0.000780420455291305;0.000169717175649167,0.000312796356829972,-0.000764597749110042,-0.00442735825290921;0.00201800238765428,-0.00284420770842872,0.0370736272312196,-0.0646378743404102;0.00104810249133415,0.00533383743330658,0.0347053520133068,0.0854778898949138];
P2 = [0.000281248842243972,-0.000232352832529570,0.00245104684733608,-0.000600607749161040;0.000251129104434427,0.000383339328670517,-0.00218333010042060,0.00772536080753942;-0.000811084240405988,-0.000372969735013976,0.0405569730362668,-0.0449814525246299;0.00175039436937541,-0.00124246476204548,0.0182121412757040,0.0753025875783318];
P = P0+w1*P1+w2*P2;
Pi0 = [0.002593049844611,0.023253847687190,-0.166888282285876,-0.181555405746696];
Pi1 = [-0.004582376953244,0.022631948081446,-0.055291705595275,-0.060629178285234];
Pi2 = [0.002448676273746,-0.025093441547453,-0.039735569121112,-0.039581200978061];
Pi = Pi0+w1*Pi1+w2*Pi2;
K = Pi/P;
u = K*x;
dx = A0*x+B0*u+w1*(A1*x+B1*u)+w2*(A2*x+B2*u);
sys = dx;
